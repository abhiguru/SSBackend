_format_version: "2.1"
_transform: true

###
### Consumers / Credentials
###
consumers:
  - username: DASHBOARD
  - username: anon
    keyauth_credentials:
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzY5MzQxMDAwLCJleHAiOjE4OTM0NTYwMDB9.Aqgd7n3j-riUsqJ54DrU8FLgxtHx4K8vTp9Ij_h35nE
  - username: service_role
    keyauth_credentials:
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoic2VydmljZV9yb2xlIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NjkzNDEwMDAsImV4cCI6MTg5MzQ1NjAwMH0.L0z54vEiO4-NCiil4VvPD2HA3Z-_Wvt7e5axPvh7nns

###
### Access Control Lists
###
acls:
  - consumer: anon
    group: anon
  - consumer: service_role
    group: admin

###
### Dashboard Auth
###
basicauth_credentials:
  - consumer: DASHBOARD
    username: supabase
    password: masala-dashboard-2024

###
### API Routes
###
services:
  ## PostgREST - Database REST API
  ## PERFORMANCE: Items 23-24 - Rate limiting and request tracking
  - name: rest-v1
    url: http://rest:3000/
    routes:
      - name: rest-v1
        strip_path: true
        paths:
          - /rest/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: true
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - anon
                - admin
          # Item 23: Gateway-level rate limiting
          - name: rate-limiting
            config:
              minute: 120
              policy: local
              hide_client_headers: false
          # Item 24: Request ID tracking for debugging
          - name: correlation-id
            config:
              header_name: X-Request-ID
              generator: uuid
              echo_downstream: true

  ## PostgREST RPC (remote procedure calls)
  - name: rest-v1-rpc
    url: http://rest:3000/rpc/
    routes:
      - name: rest-v1-rpc
        strip_path: true
        paths:
          - /rest/v1/rpc/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: true
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - anon
                - admin
          # Item 23: Rate limiting for RPC calls
          - name: rate-limiting
            config:
              minute: 60
              policy: local
              hide_client_headers: false
          - name: correlation-id
            config:
              header_name: X-Request-ID
              generator: uuid
              echo_downstream: true

  ## Storage API - Public objects (no auth required)
  ## Must be listed before the authenticated storage route so Kong
  ## matches the more-specific path first.
  ## PERFORMANCE: Item 22 - Response caching for static assets
  - name: storage-v1-public
    url: http://storage:5000/object/public/
    routes:
      - name: storage-v1-public
        strip_path: true
        paths:
          - /storage/v1/object/public/
        plugins:
          - name: cors
          # Item 22: Cache public storage objects
          - name: proxy-cache
            config:
              response_code:
                - 200
              request_method:
                - GET
                - HEAD
              content_type:
                - image/png
                - image/jpeg
                - image/webp
                - image/gif
                - image/svg+xml
              cache_ttl: 3600
              strategy: memory
              memory:
                dictionary_name: kong_db_cache

  ## Storage API - Render/transform (public images via imgproxy, no auth)
  - name: storage-v1-render-public
    url: http://storage:5000/render/image/public/
    routes:
      - name: storage-v1-render-public
        strip_path: true
        paths:
          - /storage/v1/render/image/public/
        plugins:
          - name: cors
          # Item 22: Cache transformed images
          - name: proxy-cache
            config:
              response_code:
                - 200
              request_method:
                - GET
                - HEAD
              content_type:
                - image/png
                - image/jpeg
                - image/webp
              cache_ttl: 3600
              strategy: memory
              memory:
                dictionary_name: kong_db_cache

  ## Storage API (authenticated)
  - name: storage-v1
    url: http://storage:5000/
    routes:
      - name: storage-v1
        strip_path: true
        paths:
          - /storage/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: true
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - anon
                - admin
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: correlation-id
            config:
              header_name: X-Request-ID
              generator: uuid
              echo_downstream: true

  ## Edge Functions - Shiprocket Webhook (no API key required, auth via anx-api-key header)
  ## Two routes: original path + short /webhook alias for Shiprocket dashboard
  - name: functions-v1-shiprocket-webhook
    url: http://functions:9000/shiprocket-webhook
    routes:
      - name: functions-v1-shiprocket-webhook
        strip_path: true
        paths:
          - /functions/v1/shiprocket-webhook
        plugins:
          - name: cors
          - name: correlation-id
            config:
              header_name: X-Request-ID
              generator: uuid
              echo_downstream: true
      - name: shiprocket-webhook-short
        strip_path: true
        paths:
          - /webhook
        plugins:
          - name: cors

  ## Edge Functions
  - name: functions-v1
    url: http://functions:9000/
    routes:
      - name: functions-v1
        strip_path: true
        paths:
          - /functions/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: true
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - anon
                - admin
          # Item 23: Rate limiting for edge functions
          - name: rate-limiting
            config:
              minute: 60
              policy: local
              hide_client_headers: false
          - name: correlation-id
            config:
              header_name: X-Request-ID
              generator: uuid
              echo_downstream: true

  ## Postgres Meta
  - name: meta
    url: http://meta:8080/
    routes:
      - name: meta
        strip_path: true
        paths:
          - /pg/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: true
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
          # Stricter rate limit for admin endpoints
          - name: rate-limiting
            config:
              minute: 30
              policy: local
